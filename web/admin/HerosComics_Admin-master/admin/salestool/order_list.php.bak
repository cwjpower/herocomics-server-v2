<?php 
require_once '../../wps-config.php';
require_once INC_PATH . '/classes/WpsPaginator.php';


$user_id = wps_get_current_user_id();

// page number
$page = empty($_GET['page']) ? 1 : $_GET['page'];

// search
$qa1 = empty($_GET['qa1']) ? '' : trim($_GET['qa1']);
$q1 = !isset($_GET['q1']) ? '' : trim($_GET['q1']);
$qa2 = empty($_GET['qa2']) ? '' : trim($_GET['qa2']);
// $q2 = !isset($_GET['q2']) ? '' : trim($_GET['q2']);
$qa3 = empty($_GET['qa3']) ? '' : trim($_GET['qa3']);
$q3 = !isset($_GET['q3']) ? '' : trim($_GET['q3']);

$period_from = empty($_GET['period_from']) ? '' : $_GET['period_from'];
$period_to = empty($_GET['period_to']) ? '' : $_GET['period_to'];

error_log($period_from);
$sql = '';
$pph = '';
$sparam = [];


// 검색어
if ( !empty($qa1) && !empty($q1) ) {
	$sql .= " AND $qa1 LIKE ?";
	array_push( $sparam, '%' . $q1 . '%' );
}

// 기간
if ( !empty($qa2) && !empty($period_from) && !empty($period_to) ) {
	$sql .= " AND $qa2 BETWEEN ? AND ?";
	array_push( $sparam, $period_from, $period_to );
}

// 책
if ( !empty($qa3) && !empty($q3) ) {
	$sql .= " AND $qa3 LIKE ?";
	array_push( $sparam, '%' . $q3 . '%' );
}

// Positional placeholder ?
if ( !empty($sql) ) {
	$pph_count = substr_count($sql, '?');
	for ( $i = 0; $i < $pph_count; $i++ ) {
		$pph .= 's';
	}
}

if (!empty($pph)) {
	array_unshift($sparam, $pph);
}

error_log($sql);

/**
 *

$query = "
			SELECT
				o.order_id,
			    COUNT(*) AS count_order,
				o.order_status,
				o.total_amount,
				o.cybercash_paid,
				o.created_dt,
				o.updated_dt,
				u.user_name,
				u.display_name,
			    i.book_title
			FROM
				bt_order AS o
			INNER JOIN
				bt_order_item AS i
                        LEFT JOIN
                                bt_books AS b
                        ON
                                b.ID = i.book_id
                        WHERE
				o.order_id = i.order_id
				$sql
			GROUP BY
				o.order_id,
				i.book_title
			ORDER BY
				o.order_id DESC
 */

if (wps_is_admin()) {
	$query = "
			SELECT
				o.order_id,
			    COUNT(*) AS count_order,
				o.order_status,
				o.total_amount,
				o.cybercash_paid,
				o.created_dt,
				o.updated_dt,
				u.user_name,
				u.display_name,
			    i.book_title
			FROM
				bt_order AS o
			INNER JOIN
				bt_order_item AS i
			ON o.order_id = i.order_id	
                        LEFT JOIN
                        LEFT JOIN
                                bt_users AS u
                        ON
                                u.ID = o.user_id
                                bt_books AS b
                        ON
                                b.ID = i.book_id
                        WHERE
				o.order_id = i.order_id
				$sql
			GROUP BY
				o.order_id,
				i.book_title
			ORDER BY
				o.order_id DESC
	";
} else {
	$query = "
		SELECT
			*
		FROM
			bt_books
		WHERE
			user_id = '$user_id'
			$sql
		ORDER BY
			ID DESC
	";
}

error_log($query);

error_log("local DB ========================================");
$paginator = new WpsPaginator($wdb, $page);
$rows = $paginator->ls_init_pagination( $query, $sparam );
$total_count = $paginator->ls_get_total_rows();

if (wps_is_admin()) {
	require_once ADMIN_PATH . '/admin-header.php';
} else {
	require_once ADMIN_PATH . '/agent-header.php';
}

require_once './salestool-lnb.php';
?>
			<!-- bootstrap datepicker -->
			<link rel="stylesheet" href="<?php echo ADMIN_URL ?>/css/datepicker3.css">
			
			<!-- bootstrap datepicker -->
			<script src="<?php echo ADMIN_URL ?>/js/bootstrap-datepicker.js"></script>
			<script src="<?php echo ADMIN_URL ?>/js/locales/bootstrap-datepicker.kr.js"></script>

			<!-- Content Wrapper. Contains page content -->
			<div class="content-wrapper">
				<!-- Content Header (Page header) -->
				<div class="content-header">
					<h1>
						거래 내역 조회
					</h1>
					<ol class="breadcrumb">
						<li><a href="<?php echo ADMIN_URL ?>/admin.php"><i class="fa fa-dashboard"></i> Home</a></li>
						<li><a href="<?php ECHO ADMIN_URL ?>/salestool/order_list.php">판매 관리</a></li>
						<li class="active"><b>거래 내역 조회</b></li>
					</ol>
				</div>

				<!-- Main content -->
				<div class="content body">
					<div class="box box-info">
						
						<div class="box-body">
							<form id="search-form" class="form-horizontal">
								<table class="table table-bordered ls-table">
									<colgroup>
										<col style="width: 15%;">
										<col>
									</colgroup>
									<tbody>
										<tr>
											<td class="item-label">검색어</td>
											<td>
												<div class="col-sm-3">
													<select name="qa1" class="form-control">
														<optgroup label="키워드 검색">
															<option value="">-선택-</option>
															<option value="u.user_name" <?php echo strcmp($qa1, 'u.user_name') ? '' : 'selected'; ?>>주문자 명</option>
															<option value="u.user_login" <?php echo strcmp($qa1, 'u.user_login') ? '' : 'selected'; ?>>주문자 ID</option>
															<option value="u.mobile" <?php echo strcmp($qa1, 'u.mobile') ? '' : 'selected'; ?>>주문자 연락처</option>
															<option value="u.user_email" <?php echo strcmp($qa1, 'u.user_email') ? '' : 'selected'; ?>>주문자 E-mail</option>
														</optgroup>
													</select>
												</div>
												<div class="col-sm-3">
													<input type="text" name="q1" value="<?php echo $q1 ?>" class="form-control">
												</div>
											</td>
										</tr>
										<tr>
											<td class="item-label">기간</td>
											<td>
												<div class="col-sm-3">
													<select name="qa2" class="form-control">
														<optgroup label="키워드 검색">
															<option value="">-선택-</option>
															<option value="o.created_dt" <?php echo strcmp($qa2, 'o.created_dt') ? 'selected' : 'selected'; ?>>주문일</option>
<!--															<option value="o.updated_dt" --><?php //echo strcmp($qa2, 'o.updated_dt') ? '' : 'selected'; ?><!-->결제일</option>-->
														</optgroup>
													</select>
												</div>

												<div class="col-sm-5">
													<a class="btn btn-info btn-xs wps-date" title="0">오늘</a>
													<a class="btn btn-info btn-xs wps-date" title="1">어제</a>
													<a class="btn btn-info btn-xs wps-date" title="7">최근 7일</a>
													<a class="btn btn-info btn-xs wps-date" title="15">최근 15일</a>
													<a class="btn btn-info btn-xs wps-date" title="30">최근 30일</a>
													<a class="btn btn-info btn-xs wps-date" title="60">최근 60일</a>
													<a class="btn btn-info btn-xs wps-date" title="90">최근 90일</a>
												</div>
												<div class="col-sm-4">
													<div class="input-group datepicker input-daterange">
														<input type="text" id="period_from" name="period_from" value="<?php echo $period_from ?>" class="form-control">
														<span class="input-group-addon">~</span>
														<input type="text" id="period_to" name="period_to" value="<?php echo $period_to ?>" class="form-control">
													</div>
												</div>

											</td>
										</tr>
										<tr>
											<td class="item-label">책</td>
											<td>
												<div class="col-sm-3">
													<select name="qa3" class="form-control">
														<optgroup label="키워드 검색">
															<option value="">-선택-</option>
															<option value="i.book_title" <?php echo strcmp($qa3, 'i.book_title') ? '' : 'selected'; ?>>책 이름</option>
															<option value="b.author" <?php echo strcmp($qa3, 'b.author') ? '' : 'selected'; ?>>저자</option>
															<option value="b.publisher" <?php echo strcmp($qa3, 'b.publisher') ? '' : 'selected'; ?>>출판사</option>
															<option value="b.isbn" <?php echo strcmp($qa3, 'b.isbn') ? '' : 'selected'; ?>>ISBN</option>
														</optgroup>
													</select>
												</div>
												<div class="col-sm-3">
													<input type="text" name="q3" value="<?php echo $q3 ?>" class="form-control">
												</div>
												<div class="col-sm-3">
													<button type="submit" class="btn btn-primary btn-flat">검색</button> &nbsp;
													<button type="button" id="reset-btn" class="btn btn-default btn-flat">초기화</button>
												</div>
											</td>
										</tr>
									</tbody>
								</table>
							</form>
						</div><!-- /.box -->
					</div>

					<div class="box box-primary">
						<div class="box-header">
							<div>
								<i class="fa fa-circle-o text-yellow"></i> 결과: <b><?php echo number_format($total_count) ?></b>
							</div>
						</div>
						<div class="box-body">
							<table class="table table-striped table-hover">
								<thead>
									<tr>
										<th>주문일(결제일)</th>
										<th>주문번호</th>
										<th>주문자</th>
										<th>책 제목</th>
										<th>결재 금액</th>
<!--										<th>실결제금액</th>-->
										<th>결제수단</th>
										<th>결제상태</th>
                                        <th>PG 승인번호</th>
<!--										<th>비고</th>-->
<!--										<th>메모</th>-->
									</tr>
								</thead>
								<tbody>
					<?php
					if ( !empty($rows) ) {
						$list_no = $page == 1 ? $total_count : $total_count - (($page - 1) * $paginator->rows_per_page);
						
						foreach ( $rows as $key => $val ) {

						    //print_r($val);
							$order_id = $val['order_id'];
							$order_status = $val['order_status'];
							$book_title = $val['book_title'];
							$total_amount = $val['total_amount'];
							$cybercash_paid = $val['cybercash_paid']; // 실 결재 금액? 의미 없음 제외
							$created_dt = $val['created_dt'];
							$updated_dt = $val['updated_dt'];
							$user_name = $val['user_name'];
							$display_name = $val['display_name'];
							$count_order = $val['count_order'];
							$pg_code = $val['meta_value'];
							if ($count_order > 1) {
								$book_title .= ' 외 ' . ($count_order - 1) . '권';
							}
					?>
									<tr>
										<td><?php echo substr($created_dt, 0, 10) ?></td>
										<td><a href="order_view.php?id=<?php echo $order_id ?>"><?php echo $order_id ?></a></td>
										<td><?php echo $user_name ?>(<?php echo $display_name; ?>)</td>
										<td><?php echo $book_title ?></td>
										<td><?php echo number_format($total_amount) ?></td>
<!--										<td>--><?php //echo number_format($cybercash_paid) ?><!--</td>-->
										<td><?php echo ($total_amount =='0') ? "-": "card"; ?></td>
										<td><?php echo $wps_order_status[$order_status] ?></td>
										<td><?php echo ($total_amount =='0') ? "-": $pg_code; ?></td>
<!--										<td>비고</td>-->
<!--										<td>메모</td>-->
									</tr>
					<?php
							$list_no--;
						}
					}
					?>
								</tbody>
							</table>
						</div>
						<div class="box-footer text-center">
							<?php echo $paginator->ls_bootstrap_pagination_link(); ?>
						</div>
					</div><!-- /.box -->

				</div><!-- /.content -->
			</div><!-- /.content-wrapper -->
			
			<!-- InputMask -->
			<script src="<?php echo ADMIN_URL ?>/js/jquery/input-mask/jquery.inputmask.js"></script>
			<script src="<?php echo ADMIN_URL ?>/js/jquery/input-mask/jquery.inputmask.date.extensions.js"></script>
			<script src="<?php echo ADMIN_URL ?>/js/jquery/input-mask/jquery.inputmask.extensions.js"></script>
			<!-- Numeric -->
			<script src="<?php echo INC_URL ?>/js/jquery/jquery.number.min.js"></script>
			
			<script>
			$(function() {
				//Date picker
				$('.datepicker').datepicker({
			    	autoclose: true,
			    	language: 'kr',
			    	format: 'yyyy-mm-dd'
				});
	
				//Datemask yyyy-mm/dd
			    $("[data-mask]").inputmask();
	
				$("#reset-btn").click(function() {
					$("#search-form :input").val("");
				});
				$("#adv-reset-btn").click(function() {
					$("#adv-search-form :input").val("");
					$('select[name="price_which"] option:eq(0)').attr("selected", "selected");
				});

				$(".numeric").number( true, 0 );

				// 단축아이콘
			    $(".wps-date").click(function(e) {
				    e.preventDefault();

				    var period = $(this).attr("title");
				    var dt = new Date();
				    var from, to, fmonth, fdate, tmonth, tdate = "";

				    // 오늘
				    tmonth = dt.getMonth() + 1;
				    tdate =  dt.getDate();

				    if (tmonth < 10) {
					    tmonth = "0" + tmonth;
				    }
				    if (tdate < 10) {
					    tdate = "0" + tdate;
				    }
				    to = dt.getFullYear() + "-" + tmonth + "-" + tdate;

				    // period 전
				    dt.setDate(dt.getDate() - period);

				    fmonth = dt.getMonth() + 1;
				    fdate =  dt.getDate();

				    if (fmonth < 10) {
					    fmonth = "0" + fmonth;
				    }
				    if (fdate < 10) {
					    fdate = "0" + fdate;
				    }
				    
				    from = dt.getFullYear() + "-" + fmonth + "-" + fdate;

				    $("#period_from").val(from);
				    $("#period_to").val(to);

// 				    $("#search-form").submit();
				    
				});
			});
			</script>

<?php 
require_once ADMIN_PATH . '/admin-footer.php';
?>